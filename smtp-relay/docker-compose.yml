name: smtp-relay
services:
  postfix-relay:
    image: mwader/postfix-relay:1.1.39
    ports:
      - name: smtp
        target: 25
        host_ip: 192.168.4.241
        published: 25
        protocol: tcp
        app_protocol: smtp
        mode: ingress
    restart: unless-stopped
    environment:
      TZ: Europe/Berlin
      OPENDKIM_DOMAINS: 'pc-ziegert.de'
      POSTFIX_mydestination: 'localhost'
      POSTFIX_myhostname: smtp.pc-ziegert.de
      POSTFIX_mynetworks: 0.0.0.0/0
      POSTFIX_relayhost: '[pcziegert-de0e.mail.protection.outlook.com]'
      POSTFIX_smtp_sasl_security_options: noanonymous
      POSTFIX_smtp_sasl_tls_security_options: noanonymous
      POSTFIX_smtp_tls_security_level: encrypt
      POSTFIX_smtp_use_tls: 'yes'
      POSTFIX_smtp_tls_cert_file: /etc/pki/tls/certs/smtp-pc-ziegert-de.crt
      POSTFIX_smtp_tls_key_file: /etc/pki/tls/private/smtp-pc-ziegert-de.key
      POSTFIX_smtpd_tls_cert_file: /etc/pki/tls/certs/smtp-pc-ziegert-de.crt
      POSTFIX_smtpd_tls_key_file: /etc/pki/tls/private/smtp-pc-ziegert-de.key
      POSTFIX_smtpd_tls_security_level: may
      POSTFIX_transport_maps: 'hash:/etc/postfix/transport'
      POSTMAP_transport: 'mail@localhost discard:'
    volumes:
      - type: bind
        source: /mnt/ssd/appdata/smtp-relay/data
        target: /var/lib/postfix
      - type: bind
        source: /mnt/ssd/appdata/smtp-relay/mail
        target: /var/mail
      - type: bind
        source: /mnt/ssd/appdata/smtp-relay/spool
        target: /var/spool/postfix
      - type: bind
        source: /mnt/ssd/appdata/smtp-relay/dkim
        target: /etc/opendkim/keys
      - type: bind
        source: /etc/certificates/smtp-pc-ziegert-de.key
        target: /etc/pki/tls/private/smtp-pc-ziegert-de.key
      - type: bind
        source: /etc/certificates/smtp-pc-ziegert-de.crt
        target: /etc/pki/tls/certs/smtp-pc-ziegert-de.crt
    networks:
      - smtp-relay
    healthcheck:
      test:
        - CMD
        - postfix
        - status
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 30s
      start_interval: 5s

networks:
  smtp-relay: